<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <title>Turnito - Gestión de Localidades</title> <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <link href="css/styles.css" rel="stylesheet" />
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
            .container { max-width: 960px; margin: 0 auto; padding: 20px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
            h1, h2 { text-align: center; color: #333; margin-bottom: 25px; }
            .section-card { background-color: #f8f9fa; padding: 25px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #e0e0e0; }
            .form-label { font-weight: bold; margin-bottom: 8px; display: block; color: #555; }
            .form-select, .form-control { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
            .btn-primary { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; display: block; width: 100%; text-align: center; }
            .btn-primary:hover { background-color: #0056b3; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
            th { background-color: #e9ecef; color: #333; }
            tr:nth-child(even) { background-color: #f2f2f2; }
            .text-danger { color: #dc3545; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Turnito - Gestión de Localidades</h1>

            <div class="section-card">
                <h2>Filtrar Localidades</h2>
                <div class="mb-3">
                    <label for="selectProvincia" class="form-label">Seleccione una Provincia:</label>
                    <select class="form-select" id="selectProvincia">
                        <option value="0">-- Todas las Provincias --</option>
                        <option th:each="provincia : ${provincias}"
                                th:value="${provincia.id}"
                                th:text="${provincia.nombre}"></option>
                    </select>
                </div>
            </div>

			<div class="section-card">
			                <h2>Listado de Localidades</h2>
			                <div style="max-height: 250px; overflow-y: auto;">
			                    <table class="table table-striped">
			                        <thead>
			                            <tr>
			                                <th>Localidad</th>
			                                <th>Provincia</th>
			                                <th>Eliminar</th> </tr>
			                        </thead>
			                        <tbody id="tablaLocalidadesBody">
			                            <tr>
			                                <td colspan="3">Seleccione una provincia o elija "Todas las Provincias" para comenzar.</td>
			                            </tr>
			                        </tbody>
			                    </table>
			                </div>
			            </div>

            <div class="section-card">
                <h2>Agregar Nueva Localidad</h2>
                <form action="#" th:action="@{/localidades/}" th:object="${localidad}" method="post">
                    <div class="mb-3">
                        <label for="nombreLocalidad" class="form-label">Nombre:</label>
                        <input type="text" class="form-control" id="nombreLocalidad" th:field="*{nombre}" />
                    </div>
                    <div class="mb-3">
                        <label for="nuevaProvincia" class="form-label">Provincia:</label>
                        <select class="form-select" id="nuevaProvincia" th:field="*{provincia.id}">
                            <option value="">Seleccione una Provincia</option>
                            <option th:each="provincia : ${provincias}"
                                    th:value="${provincia.id}"
                                    th:text="${provincia.nombre}"></option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar Localidad</button>
                </form>
            </div>
        </div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
		        <script>
		            document.addEventListener('DOMContentLoaded', function() {
		                const selectProvincia = document.getElementById('selectProvincia');
		                const tablaLocalidadesBody = document.getElementById('tablaLocalidadesBody');

		                // Cargar localidades al inicio.
		                cargarLocalidades(selectProvincia.value);

		                selectProvincia.addEventListener('change', function() {
		                    const provinciaId = this.value;
		                    cargarLocalidades(provinciaId);
		                });

		                function cargarLocalidades(provinciaId) {
		                    tablaLocalidadesBody.innerHTML = ''; // Limpiar la tabla

		                    let url = `/localidades/porProvincia?provinciaId=${provinciaId}`;

		                    fetch(url)
		                        .then(response => {
		                            if (!response.ok) {
		                                throw new Error('Network response was not ok ' + response.statusText);
		                            }
		                            return response.json();
		                        })
		                        .then(data => {
		                            if (data.length === 0) {
		                                const row = document.createElement('tr');
		                                row.innerHTML = `<td colspan="3">No hay localidades para esta provincia.</td>`; // Colspan 3
		                                tablaLocalidadesBody.appendChild(row);
		                            } else {
		                                data.forEach(localidad => {
		                                    const row = document.createElement('tr');
		                                    // Asegúrate de que el 'id' de la localidad está disponible
		                                    row.innerHTML = `
		                                        <td>${localidad.nombre}</td>
		                                        <td>${localidad.provincia ? localidad.provincia.nombre : 'N/A'}</td>
												<td>
												                                        <button class="btn btn-danger btn-sm btn-delete-localidad" data-id="${localidad.id}">
												                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash text-white" viewBox="0 0 16 16">
												                                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
												                                                <path d="M14.5 3a1 1 0 0 1-1 1H13V9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
												                                            </svg>
												                                        </button>
												                                    </td>
		                                    `;
		                                    tablaLocalidadesBody.appendChild(row);
		                                });
		                                // Después de llenar la tabla, attach event listeners a los botones de eliminar
		                                attachDeleteEventListeners();
		                            }
		                        })
		                        .catch(error => {
		                            console.error('Error al cargar localidades:', error);
		                            const row = document.createElement('tr');
		                            row.innerHTML = `<td colspan="3" class="text-danger">Error al cargar localidades.</td>`; // Colspan 3
		                            tablaLocalidadesBody.appendChild(row);
		                        });
		                }

		                // Función para adjuntar eventos a los botones de eliminar
		                function attachDeleteEventListeners() {
		                    document.querySelectorAll('.btn-delete-localidad').forEach(button => {
		                        button.addEventListener('click', function() {
		                            const localidadId = this.dataset.id; // Obtiene el ID del atributo data-id
		                            if (confirm('¿Estás seguro de que quieres eliminar esta localidad?')) {
		                                deleteLocalidad(localidadId);
		                            }
		                        });
		                    });
		                }

		                // Función para enviar la solicitud DELETE al backend
		                function deleteLocalidad(id) {
		                    fetch(`/localidades/${id}`, {
		                        method: 'DELETE', // Método DELETE
		                        headers: {
		                            'Content-Type': 'application/json'
		                            // Si usas CSRF, necesitarías agregar un header X-CSRF-TOKEN
		                        }
		                    })
		                    .then(response => {
		                        if (response.ok) {
		                            alert('Localidad eliminada exitosamente.');
		                            // Recargar las localidades para que la tabla se actualice
		                            cargarLocalidades(selectProvincia.value);
		                        } else {
		                            // Leer el mensaje de error del backend si lo hay
		                            response.text().then(text => {
		                                alert('Error al eliminar localidad: ' + text);
		                            });
		                        }
		                    })
		                    .catch(error => {
		                        console.error('Error en la solicitud de eliminación:', error);
		                        alert('Error de conexión al intentar eliminar la localidad.');
		                    });
		                }
		            });
		        </script>
		        </body>
		
</html>