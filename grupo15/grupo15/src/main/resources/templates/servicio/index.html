<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Servicios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Gestión de Turnos</a>
    </div>
</nav>

<div class="container mt-4">
    <h1 class="mb-4">Servicios</h1>

    <form id="servicio-form" class="mb-4">
        <input type="hidden" id="servicio-id">

        <div class="mb-3">
            <label for="nombre" class="form-label">Nombre del Servicio</label>
            <input type="text" class="form-control" id="nombre" required>
        </div>

        <div class="mb-3">
            <label for="duracion" class="form-label">Duración (minutos)</label>
            <input type="number" class="form-control" id="duracion" required>
        </div>

        <div class="mb-3">
            <label for="estado" class="form-label">Estado</label>
            <select class="form-select" id="estado" required>
                <option value="true">Activo</option>
                <option value="false">Inactivo</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="horarioInicio" class="form-label">Horario de Inicio</label>
            <input type="time" class="form-control" id="horarioInicio" required>
        </div>

        <div class="mb-3">
            <label for="horarioFin" class="form-label">Horario de Fin</label>
            <input type="time" class="form-control" id="horarioFin" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Días de la Semana</label>
            <div class="form-check form-check-inline" id="dias-checkboxes"></div>
        </div>

        <div class="mb-3">
            <label for="servicioLugares" class="form-label">Ubicaciones y Profesionales</label>
            <select multiple class="form-select" id="servicioLugares"></select>
        </div>

        <button type="submit" class="btn btn-primary">Guardar</button>
    </form>

    <h2>Servicios Cargados</h2>
    <table class="table table-bordered" id="tabla-servicios">
        <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Duración</th>
                <th>Estado</th>
                <th>Horario</th>
                <th>Días</th>
                <th>Ubicaciones y Profesionales</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("servicio-form");
    const tabla = document.querySelector("#tabla-servicios tbody");

    const inputId = document.getElementById("servicio-id");
    const inputNombre = document.getElementById("nombre");
    const inputDuracion = document.getElementById("duracion");
    const inputEstado = document.getElementById("estado");
    const inputInicio = document.getElementById("horarioInicio");
    const inputFin = document.getElementById("horarioFin");
    const selectServicioLugares = document.getElementById("servicioLugares");

    const diasSemana = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"];
    const diasLabels = {
        MONDAY: "Lunes", TUESDAY: "Martes", WEDNESDAY: "Miércoles", THURSDAY: "Jueves",
        FRIDAY: "Viernes", SATURDAY: "Sábado", SUNDAY: "Domingo"
    };
    const diasContainer = document.getElementById("dias-checkboxes");

    diasSemana.forEach(dia => {
        diasContainer.innerHTML += `
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="dia-${dia}" value="${dia}">
                <label class="form-check-label" for="dia-${dia}">${diasLabels[dia]}</label>
            </div>
        `;
    });

    function cargarOpcionesServicioLugar() {
        fetch("/serviciolugar/api")
            .then(res => res.json())
            .then(data => {
                selectServicioLugares.innerHTML = "";
                data.forEach(sl => {
                    if (sl.activo) {
                        const opt = document.createElement("option");
                        opt.value = sl.id;
                        opt.textContent = `${sl.lugarNombre} - ${sl.profesionalNombre}`;
                        selectServicioLugares.appendChild(opt);
                    }
                });
            });
    }

    function cargarServicios() {
        fetch("/servicios/api")
            .then(res => res.json())
            .then(servicios => {
                tabla.innerHTML = "";
                servicios.forEach(servicio => {
                    const fila = document.createElement("tr");

                    const lugarTexto = (servicio.servicioLugares || []).map(sl =>
                        `${sl.lugarNombre} - ${sl.profesionalNombre}`
                    ).join(", ");

                    const diasTexto = (servicio.diasSemana || []).map(d => diasLabels[d]).join(", ");

                    fila.innerHTML = `
                        <td>${servicio.id}</td>
                        <td>${servicio.nombre}</td>
                        <td>${servicio.duracionMinutos} min</td>
                        <td>${servicio.estado ? 'Activo' : 'Inactivo'}</td>
                        <td>${servicio.horarioInicio} - ${servicio.horarioFin}</td>
                        <td>${diasTexto}</td>
                        <td>${lugarTexto}</td>
                        <td>
                            <button class="btn btn-sm btn-info btn-editar" data-id="${servicio.id}">Editar</button>
                            <button class="btn btn-sm btn-danger btn-eliminar" data-id="${servicio.id}">Eliminar</button>
                        </td>
                    `;
                    tabla.appendChild(fila);
                });

                document.querySelectorAll(".btn-editar").forEach(btn =>
                    btn.addEventListener("click", () => cargarServicioPorId(btn.dataset.id))
                );

                document.querySelectorAll(".btn-eliminar").forEach(btn =>
                    btn.addEventListener("click", () => eliminarServicio(btn.dataset.id))
                );
            });
    }

    function cargarServicioPorId(id) {
        fetch(`/servicios/api/${id}`)
            .then(res => res.json())
            .then(servicio => {
                inputId.value = servicio.id;
                inputNombre.value = servicio.nombre;
                inputDuracion.value = servicio.duracionMinutos;
                inputEstado.value = servicio.estado;
                inputInicio.value = servicio.horarioInicio;
                inputFin.value = servicio.horarioFin;

                document.querySelectorAll("#dias-checkboxes input").forEach(cb => {
                    cb.checked = servicio.diasSemana?.includes(cb.value);
                });

                Array.from(selectServicioLugares.options).forEach(opt => {
                    opt.selected = servicio.servicioLugares?.some(sl => sl.id === parseInt(opt.value));
                });
            });
    }

    function eliminarServicio(id) {
        if (confirm("¿Seguro que desea eliminar este servicio?")) {
            fetch(`/servicios/api/${id}`, { method: "DELETE" })
                .then(() => cargarServicios());
        }
    }

    form.addEventListener("submit", e => {
        e.preventDefault();

        const diasSeleccionados = Array.from(document.querySelectorAll("#dias-checkboxes input:checked")).map(cb => cb.value);
        const servicioLugarIdsSeleccionados = Array.from(selectServicioLugares.selectedOptions).map(opt => parseInt(opt.value));

        const data = {
            nombre: inputNombre.value,
            duracionMinutos: parseInt(inputDuracion.value),
            estado: inputEstado.value === "true",
            horarioInicio: inputInicio.value,
            horarioFin: inputFin.value,
            diasSemana: diasSeleccionados,
            servicioLugarIds: servicioLugarIdsSeleccionados
        };

        const method = inputId.value ? "PUT" : "POST";
        const url = inputId.value ? `/servicios/api/${inputId.value}` : "/servicios/api";

        fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        }).then(() => {
            form.reset();
            inputId.value = "";
            cargarServicios();
        });
    });

    cargarOpcionesServicioLugar();
    cargarServicios();
});
</script>
</body>
</html>
